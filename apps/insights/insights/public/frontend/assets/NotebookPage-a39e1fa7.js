var $e=Object.defineProperty;var B=Object.getOwnPropertySymbols;var oe=Object.prototype.hasOwnProperty,ne=Object.prototype.propertyIsEnumerable;var te=(o,e,t)=>e in o?$e(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t,ae=(o,e)=>{for(var t in e||(e={}))oe.call(e,t)&&te(o,t,e[t]);if(B)for(var t of B(e))ne.call(e,t)&&te(o,t,e[t]);return o};var se=(o,e)=>{var t={};for(var a in o)oe.call(o,a)&&e.indexOf(a)<0&&(t[a]=o[a]);if(o!=null&&B)for(var a of B(o))e.indexOf(a)<0&&ne.call(o,a)&&(t[a]=o[a]);return t};var w=(o,e,t)=>new Promise((a,n)=>{var c=r=>{try{l(t.next(r))}catch(m){n(m)}},f=r=>{try{l(t.throw(r))}catch(m){n(m)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(c,f);l((t=t.apply(o,e)).next())});import{P as Re}from"./PageBreadcrumbs-e38fbd0a.js";import{u as Ae,C as ce,d as Se,b as re,_ as Ve,a as Ie}from"./useQuery-b1a5cdc5.js";import{u as De}from"./useNotebook-737aeb90.js";import{f as S,y as Ne,d as D,z as Te,i as Me,m as Oe,u as ze}from"./index-61e7aa99.js";import{R as de,a as Y,f as V,a_ as Qe,a$ as He,b0 as Le,P as ue,aF as pe,M as _,v as d,x as g,y as me,N as h,G as v,Z as E,B as $,z as s,a0 as Be,O as Z,aC as he,H as y,i as M,L as i,r as A,F as O,aP as T,D as P,w as fe,a5 as X,b1 as ye,a1 as ge,b2 as be,A as _e,aB as ve,J as xe,K as we,V as Fe,b3 as Pe,b4 as Ee,_ as Ue,E as je,m as le,b5 as Je,b6 as We,q as Ke,T as Ge}from"./frappe-ui-24524c82.js";import{u as Ye}from"./useDashboards-ef8a3602.js";import{g as Ze}from"./results-60b5fd7f.js";import{c as Xe,g as et}from"./useChartData-c190b291.js";import{u as K}from"./queryStore-d82f5e4a.js";import tt from"./InvalidWidget-3dda2fff.js";import{w as G,T as ot,a as nt}from"./widgets-f5903e20.js";import{s as at,_ as ke}from"./UsePopover-9747e78c.js";import{u as st}from"./dataSourceStore-3ba6c3b5.js";import"./index-45270e13.js";import"./useDataSource-327864e5.js";import"./cacheStore-8d74b582.js";import"./useDataSourceTable-f88aea74.js";const rt=S("ChevronRightSquareIcon",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"m10 8 4 4-4 4",key:"1wy4r4"}]]),lt=S("CodeIcon",[["polyline",{points:"16 18 22 12 16 6",key:"z7tu5w"}],["polyline",{points:"8 6 2 12 8 18",key:"1eg1df"}]]),it=S("Heading1Icon",[["path",{d:"M4 12h8",key:"17cfdx"}],["path",{d:"M4 18V6",key:"1rz3zl"}],["path",{d:"M12 18V6",key:"zqpxq5"}],["path",{d:"m17 12 3-2v8",key:"1hhhft"}]]),ct=S("Heading2Icon",[["path",{d:"M4 12h8",key:"17cfdx"}],["path",{d:"M4 18V6",key:"1rz3zl"}],["path",{d:"M12 18V6",key:"zqpxq5"}],["path",{d:"M21 18h-4c0-4 4-3 4-6 0-1.5-2-2.5-4-1",key:"9jr5yi"}]]),dt=S("Heading3Icon",[["path",{d:"M4 12h8",key:"17cfdx"}],["path",{d:"M4 18V6",key:"1rz3zl"}],["path",{d:"M12 18V6",key:"zqpxq5"}],["path",{d:"M17.5 10.5c1.7-1 3.5 0 3.5 1.5a2 2 0 0 1-2 2",key:"68ncm8"}],["path",{d:"M17 17.5c2 1.5 4 .3 4-1.5a2 2 0 0 0-2-2",key:"1ejuhz"}]]),ut=S("MinusIcon",[["line",{x1:"5",x2:"19",y1:"12",y2:"12",key:"13b5wn"}]]),pt=S("ParkingSquareIcon",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M9 17V7h4a3 3 0 0 1 0 6H9",key:"1dfk2c"}]]),mt=S("RemoveFormattingIcon",[["path",{d:"M4 7V4h16v3",key:"9msm58"}],["path",{d:"M5 20h6",key:"1h6pxn"}],["path",{d:"M13 4 8 20",key:"kqq6aj"}],["path",{d:"m15 15 5 5",key:"me55sn"}],["path",{d:"m20 15-5 5",key:"11p7ol"}]]),ht=S("StrikethroughIcon",[["path",{d:"M16 4H9a3 3 0 0 0-2.83 4",key:"43sutm"}],["path",{d:"M14 12a4 4 0 0 1 0 8H6",key:"nlfj13"}],["line",{x1:"4",x2:"20",y1:"12",y2:"12",key:"1e0a9i"}]]);function ft(o){const e=de({doctype:"Insights Notebook Page",name:o,transform(n){return n.content=D(n.content),n}}),t=Y({doc:{},loading:!1});t.reload=()=>w(this,null,function*(){t.loading=!0,t.doc=yield e.get.fetch(),gt(t.doc.content)&&(t.doc.content=bt()),t.loading=!1}),t.reload(),t.save=()=>w(this,null,function*(){t.loading=!0,t.doc.content=yt(t.doc.content);const n=JSON.stringify(t.doc.content,null,2);yield e.setValue.submit({title:t.doc.title||"Untitled",content:n}),t.loading=!1});const a=V(()=>{if(t.doc.name)return{title:t.doc.title,content:t.doc.content}});return Ne(a,{saveFn:t.save,interval:1500}),t.delete=()=>w(this,null,function*(){t.loading=!0,yield e.delete.submit(),t.loading=!1}),t.addQuery=(n,c)=>w(this,null,function*(){if(!["query-editor"].includes(n))throw new Error(`Invalid query type: ${n}`);t.loading=!0;const l=D(t.doc.content);l.content.push({type:n,attrs:{query:c}}),t.doc.content=l,yield t.save(),yield t.reload(),t.loading=!1}),t}function yt(o){var t,a;if(typeof o=="string"&&(o=D(o)),!((t=o.content)!=null&&t.length))return{};const e=(a=o.content)==null?void 0:a.at(-1);return(e==null?void 0:e.type)!="paragraph"&&o.content.push({type:"paragraph",attrs:{textAlign:"left"}}),o}function gt(o){var e;if(!o||(typeof o=="string"&&(o=D(o)),!o.type)||!((e=o.content)!=null&&e.length))return!0}function bt(){return{type:"doc",content:[{type:"paragraph",attrs:{textAlign:"left"},content:[{type:"text",text:"â“Donâ€™t know where to start? Start by defining your.."}]},{type:"paragraph",attrs:{textAlign:"left"},content:[{type:"text",marks:[{type:"bold"}],text:"ðŸŽ¯ Objective"},{type:"text",text:": "},{type:"text",marks:[{type:"italic"}],text:"We have to find out why so and soâ€¦"}]},{type:"paragraph",attrs:{textAlign:"left"},content:[{type:"text",marks:[{type:"bold"}],text:"ðŸ” Approach:"}]},{type:"bulletList",content:[{type:"listItem",content:[{type:"paragraph",attrs:{textAlign:"left"},content:[{type:"text",marks:[{type:"italic"}],text:"We start with this data"}]}]},{type:"listItem",content:[{type:"paragraph",attrs:{textAlign:"left"},content:[{type:"text",marks:[{type:"italic"}],text:"Combine with that data"}]}]}]},{type:"paragraph",attrs:{textAlign:"left"},content:[{type:"text",text:"âŒ Want to start from scratch? Use the clear button inside the 3-dot menu "}]}]}}function Ce(o){const c=o,{name:e,component:t,tag:a}=c,n=se(c,["name","component","tag"]);return Qe.create({name:e,group:n.group||"block",atom:n.atom||!0,addAttributes(){return n.attributes||{}},parseHTML(){return[{tag:a}]},renderHTML({HTMLAttributes:f}){return[a,He(f)]},addNodeView(){return Le(t)}})}const W={};function _t(){return w(this,null,function*(){return ue("insights.api.queries.create_chart")})}function ie(o){return W[o]||(W[o]=vt(o)),W[o]}function vt(o){const e=xt(o),t=Y({query:null,data:[],columns:[],loading:!1,error:null,options:{},autosave:!1,doc:{doctype:"Insights Chart",name:void 0,chart_type:void 0,options:{},is_public:!1}});function a(){return w(this,null,function*(){if(t.loading=!0,yield e.get.fetch(),t.doc=e.doc,!t.doc.query){t.loading=!1;return}t.doc.query=e.doc.query,n()})}a();function n(){t.loading=!0;const p=Ae(t.doc.query);p.get.fetch(),Te(()=>p.doc,()=>{if(!p.doc)return;const R=Ze(p.doc.results);if(t.columns=R[0],t.data=Xe(R),!t.doc.chart_type){const x=et(R);t.doc.chart_type=x==null?void 0:x.type,t.doc.options=x==null?void 0:x.options,t.doc.options.title=p.doc.title}t.doc.options.query=t.doc.query,t.loading=!1})}function c(){e.setValue.submit({chart_type:t.doc.chart_type,options:t.doc.options})}function f(p){t.doc.is_public!==p&&e.setValue.submit({is_public:p}).then(()=>{$notify({title:"Chart access updated",variant:"success"}),t.doc.is_public=p})}function l(p){p&&t.doc.query!==p&&(t.doc.query=p,e.setValue.submit({query:p}).then(()=>{n()}))}l=pe(l,500);let r;function m(){t.autosave=!0,r=Me(()=>t.doc,c,{deep:!0,debounce:500})}function I(){t.autosave=!1,r&&(r(),r=void 0)}function C(){return w(this,null,function*(){t.deleting=!0,yield e.delete.submit(),t.deleting=!1})}function q(p){return w(this,null,function*(){!p||!t.doc.name||t.addingToDashboard||(t.addingToDashboard=!0,yield ue("insights.api.dashboards.add_chart_to_dashboard",{dashboard:p,chart:t.doc.name}),t.addingToDashboard=!1)})}function u(){t.doc.chart_type=void 0,t.doc.options={}}return Object.assign(t,{load:a,save:c,togglePublicAccess:f,updateQuery:l,enableAutoSave:m,disableAutoSave:I,addToDashboard:q,resetOptions:u,delete:C})}function xt(o){return de({doctype:"Insights Chart",name:o,transform:e=>(e.chart_type=e.chart_type,e.options=D(e.options),e.options.query=e.query,e)})}const wt={class:"flex items-center space-x-1.5"},kt={class:"text-sm"},F={__name:"BlockAction",props:{label:String,icon:String,iconComponent:Object,action:Function,loading:Boolean},setup(o){return(e,t)=>{const a=_("FeatherIcon");return d(),g("div",{class:"flex h-8 cursor-pointer items-center rounded border border-gray-200 bg-white px-2 hover:bg-gray-50 hover:text-gray-800",onClick:t[0]||(t[0]=he(()=>!o.loading&&o.action&&o.action(),["prevent","stop"]))},[me(e.$slots,"default",{},()=>[h("div",wt,[o.iconComponent?(d(),v(E(o.iconComponent),{key:0,class:"h-4 w-4 text-gray-500"})):$("",!0),o.loading?(d(),v(s(Be),{key:1,class:"h-4 w-4 text-gray-500"})):(d(),v(a,{key:2,name:o.icon,class:"h-4 w-4 text-gray-500"},null,8,["name"])),h("span",kt,Z(o.label),1)])])])}}},Ct={class:"flex w-[10rem] flex-col space-y-1.5 text-sm transition-all"},qt={__name:"BlockActions",props:{blockRef:Object,actions:{type:Array,default:()=>[]}},setup(o){return(e,t)=>o.blockRef?(d(),v(ke,{key:0,targetElement:o.blockRef,placement:"right-start",transition:s(at)},{default:y(()=>[h("div",Ct,[me(e.$slots,"default")])]),_:3},8,["targetElement","transition"])):$("",!0)}},$t={class:"flex h-full w-full flex-col p-3"},Rt={class:"relative flex flex-shrink-0 justify-between pb-3 text-base"},At=h("span",{class:"font-code text-sm uppercase text-gray-600"}," Options ",-1),St={key:0,class:"flex w-full flex-1 flex-col gap-4 overflow-y-scroll pt-0 !text-base"},Vt={__name:"ChartOptions",props:{onClose:Function},setup(o){const e=M("chart"),t=[{label:"Select a chart type",value:void 0}].concat(G.getChartOptions());return(a,n)=>{var l;const c=_("FeatherIcon"),f=_("Input");return d(),g("div",$t,[h("div",Rt,[At,i(c,{name:"x",class:"h-4 w-4 cursor-pointer text-gray-500 transition-all hover:text-gray-800",onClick:n[0]||(n[0]=he(r=>o.onClose&&o.onClose(),["prevent","stop"]))})]),(l=s(e))!=null&&l.doc.chart_type?(d(),g("div",St,[i(f,{type:"select",label:"Chart Type",class:"w-full",modelValue:s(e).doc.chart_type,"onUpdate:modelValue":n[1]||(n[1]=r=>s(e).doc.chart_type=r),options:s(t)},null,8,["modelValue","options"]),s(e).doc.chart_type?(d(),v(E(s(G).getOptionComponent(s(e).doc.chart_type)),{key:s(e).doc.chart_type,modelValue:s(e).doc.options,"onUpdate:modelValue":n[2]||(n[2]=r=>s(e).doc.options=r),columns:s(e).columns},null,8,["modelValue","columns"])):$("",!0)])):$("",!0)])}}},It={class:"flex items-center space-x-1.5"},Dt=h("span",{class:"text-sm"},"Options",-1),Nt={class:"h-[22rem] w-[15rem] overflow-y-scroll rounded bg-white text-base shadow"},Tt={__name:"ChartOptionsDropdown",setup(o){const e=A(null);return M("chart"),(t,a)=>{const n=_("FeatherIcon");return d(),g(O,null,[h("div",{ref_key:"targetElement",ref:e,class:"flex h-full w-full items-center px-2"},[h("div",It,[i(n,{name:"settings",class:"h-3.5 w-3.5 text-gray-500"}),Dt])],512),e.value?(d(),v(ke,{key:0,targetElement:e.value,placement:"bottom-end"},{default:y(({toggle:c})=>[h("div",Nt,[i(Vt,{onClose:()=>c(!1)},null,8,["onClose"])])]),_:1},8,["targetElement"])):$("",!0)],64)}}},Mt={class:"relative h-full w-full"},Ot={key:1,class:"absolute right-0 top-0 flex h-full w-full flex-col items-center justify-center"},zt=h("div",{class:"mb-1 w-[10rem] text-gray-500"},"Select a query",-1),Qt={class:"w-[10rem] rounded border border-dashed border-gray-300"},Ht={class:"text-base"},Lt=h("span",{class:"mb-2 block text-sm leading-4 text-gray-700"},"Dashboard",-1),Bt={__name:"ChartBlock",props:{chartName:String},emits:["setChartName","remove"],setup(t,a){return w(this,arguments,function*(o,{emit:e}){let n,c;const f=o,l=A(null);let r=null;if(f.chartName)r=ie(f.chartName);else{const b=([n,c]=T(()=>_t()),n=yield n,c(),n);e("setChartName",b),r=ie(b)}r.enableAutoSave(),P("chart",r);function m(){r.delete().then(()=>e("remove"))}const C=K().list.map(b=>({label:b.title,value:b.name,description:b.name})),q=V(()=>C.find(b=>b.value===r.doc.query)),u=b=>i("div",{class:"relative flex w-full items-center text-gray-800 [&>div]:w-full"},[i(_("Autocomplete"),{placeholder:"Query",options:C,modelValue:q.value,placement:"bottom","onUpdate:modelValue":k=>r.updateQuery(k.value)},null),i("p",{class:"pointer-events-none absolute right-0 top-0 flex h-full items-center px-2"},[i(_("FeatherIcon"),{name:"chevron-down",class:"h-4 w-4 text-gray-500"},null)])]),p=A(!1),R=Ye();R.reload();const x=A(null),U=A(!1),z=V(()=>R.list.sort((b,k)=>b.title.toLowerCase()<k.title.toLowerCase()?-1:1).map(b=>({label:b.title,value:b.name}))),N=M("$notify"),qe=()=>w(this,null,function*(){x.value&&(yield r.addToDashboard(x.value.value),p.value=!1,N({variant:"success",title:"Success",message:"Chart added to dashboard"}))}),j=A(null);return fe(()=>p.value,b=>{b&&setTimeout(()=>{var k,Q,H,L;(Q=(k=j.value.input)==null?void 0:k.$el)==null||Q.blur(),(L=(H=j.value.input)==null?void 0:H.$el)==null||L.focus()},500)},{immediate:!0}),(b,k)=>{var ee;const Q=_("Autocomplete"),H=_("Button"),L=_("Dialog");return d(),g(O,null,[s(r).doc.name?(d(),g("div",{key:0,ref_key:"blockRef",ref:l,class:"group relative my-6 h-[20rem] overflow-hidden rounded border bg-white"},[(ee=s(r).doc)!=null&&ee.chart_type?(d(),v(E(s(G).getComponent(s(r).doc.chart_type)),{ref:"widget",data:s(r).data,options:s(r).doc.options,key:JSON.stringify([s(r).data,s(r).doc.options])},{placeholder:y(()=>[h("div",Mt,[i(tt,{class:"absolute",title:"Insufficient options",message:"Please check the options for this chart",icon:"settings","icon-class":"text-gray-500"})])]),_:1},8,["data","options"])):(d(),g("div",Ot,[zt,h("div",Qt,[i(u)])]))],512)):$("",!0),i(qt,{blockRef:l.value},{default:y(()=>[i(F,{class:"!px-0"},{default:y(()=>[i(u)]),_:1}),s(r).doc.query?(d(),v(F,{key:0,class:"!px-0"},{default:y(()=>[i(Tt)]),_:1})):$("",!0),i(F,{label:"Add to dashboard",icon:"plus",action:()=>p.value=!0},null,8,["action"]),i(F,{icon:"trash",label:"Delete",action:m,loading:s(r).deleting},null,8,["loading"])]),_:1},8,["blockRef"]),i(L,{options:{title:"Add to Dashboard"},modelValue:p.value,"onUpdate:modelValue":k[1]||(k[1]=J=>p.value=J)},{"body-content":y(()=>[h("div",Ht,[Lt,i(Q,{ref_key:"dashboardInput",ref:j,options:z.value,modelValue:x.value,"onUpdate:modelValue":k[0]||(k[0]=J=>x.value=J)},null,8,["options","modelValue"])])]),actions:y(()=>[i(H,{variant:"solid",onClick:qe,loading:U.value},{default:y(()=>[X(" Add ")]),_:1},8,["loading"])]),_:1},8,["modelValue"])],64)}})}},Ft={__name:"Chart",props:ye,setup(o){const e=o;return(t,a)=>(d(),v(s(be),{class:"not-prose text-base"},{default:y(()=>[(d(),v(ge,null,{default:y(()=>[i(Bt,{chartName:e.node.attrs.chart_name,onSetChartName:a[0]||(a[0]=n=>e.updateAttributes({chart_name:n})),onRemove:a[1]||(a[1]=n=>e.deleteNode())},null,8,["chartName"])]),_:1}))]),_:1}))}},Pt=Ce({name:"chart",tag:"chart",component:Ft,attributes:{chart_name:void 0}}),Et={__name:"ResizeableInput",props:{modelValue:String|Number,placeholder:String},emits:["update:modelValue"],setup(o,{emit:e}){const t=o,a=V({get:()=>t.modelValue||"",set:n=>e("update:modelValue",n)});return(n,c)=>(d(),v(ce,{modelValue:a.value,"onUpdate:modelValue":c[0]||(c[0]=f=>a.value=f),placeholder:t.placeholder,class:_e(["h-7 cursor-pointer px-2.5 leading-7 outline-none ring-0 transition-all focus:outline-none",n.$attrs.class])},null,8,["modelValue","placeholder","class"]))}},Ut={class:"flex h-9 items-center justify-between rounded-t-lg pl-3 pr-1 text-base"},jt={class:"flex items-center font-mono"},Jt={key:0,class:"mr-1"},Wt={class:"text-gray-600"},Kt={class:"flex items-center space-x-2"},Gt={class:"relative"},Yt=["innerHTML"],Zt={__name:"QueryBlockHeader",setup(o){const e=M("state"),t=pe(u=>w(this,null,function*(){yield e.query.updateDoc({title:u})}),1500),a=A(!1),n=V(()=>e.query.doc.sql.replaceAll(`
`,"<br>").replaceAll("      ","&ensp;&ensp;&ensp;&ensp;")),c=M("page"),f=ve();function l(){e.query.duplicate().then(u=>{c!=null&&c.addQuery?c.addQuery("query-editor",u):f.push(`/query/build/${u}`)})}const r=st(),m=u=>i("div",{class:"group flex w-full cursor-pointer items-center justify-between rounded-md px-2 py-2 text-sm hover:bg-gray-100",onClick:()=>q(u.name)},[i("span",null,[u.label]),xe(i(_("FeatherIcon"),{name:"check",class:"h-4 w-4 text-gray-600"},null),[[we,u.active]])]),I=V(()=>r.list.find(u=>u.name===e.query.doc.data_source)),C=V(()=>r.list.map(u=>({component:p=>i(m,{name:u.name,label:u.title,active:u.name===e.query.doc.data_source},null)})));function q(u){e.query.updateDoc({data_source:u}).then(()=>{$notify({title:"Data source updated",variant:"success"}),e.query.doc.data_source=u})}return(u,p)=>{var z;const R=_("Dropdown"),x=_("Button"),U=_("Dialog");return d(),g(O,null,[h("div",Ut,[h("div",jt,[s(e).query.doc.is_stored?(d(),g("div",Jt,[i(s(Se),{class:"h-3 w-3 text-gray-600",fill:"currentColor"})])):$("",!0),i(Et,{modelValue:s(e).query.doc.title,"onUpdate:modelValue":[p[0]||(p[0]=N=>s(e).query.doc.title=N),s(t)],class:"-ml-2 cursor-text"},null,8,["modelValue","onUpdate:modelValue"]),h("p",Wt,"("+Z(s(e).query.doc.name)+")",1)]),h("div",Kt,[i(R,{button:{iconLeft:"database",variant:"outline",label:((z=I.value)==null?void 0:z.title)||"Select data source"},options:C.value},null,8,["button","options"]),i(x,{variant:"outline",icon:"play",label:"Execute",onClick:()=>s(e).query.execute()||(s(e).minimizeResult=!1),loading:s(e).query.executing},null,8,["onClick","loading"]),i(R,{button:{icon:"more-vertical",variant:"outline"},options:[{label:s(e).minimizeResult?"Show Results":"Hide Results",icon:s(e).minimizeResult?"maximize-2":"minimize-2",onClick:()=>s(e).minimizeResult=!s(e).minimizeResult},{label:"Duplicate",icon:"copy",onClick:l,loading:s(e).query.duplicating},{label:"View SQL",icon:"code",onClick:()=>a.value=!0,loading:s(e).query.duplicating},{label:"Delete",icon:"trash",onClick:s(e).removeQuery,loading:s(e).query.deleting}]},null,8,["options"])])]),i(U,{options:{title:"Generated SQL",size:"3xl"},modelValue:a.value,"onUpdate:modelValue":p[2]||(p[2]=N=>a.value=N),dismissable:!0},{"body-content":y(()=>[h("div",Gt,[h("p",{class:"rounded border bg-gray-100 p-2 text-base text-gray-600",style:{"font-family":"'Fira Code'"},innerHTML:n.value},null,8,Yt),i(x,{icon:"copy",variant:"outline",class:"absolute bottom-2 right-2",onClick:p[1]||(p[1]=N=>s(Oe)(s(e).query.doc.sql))})])]),_:1},8,["modelValue"])],64)}}},Xt={key:0,ref:"blockRef",class:"relative my-6 overflow-hidden rounded border bg-white"},eo={class:"mb-2 w-full flex-1 overflow-hidden"},to={key:0,class:"group relative flex max-h-80 flex-col overflow-hidden border-t bg-white"},oo={key:1,class:"flex h-20 w-full flex-col items-center justify-center"},no={__name:"QueryBlock",props:{query:String},emits:["setQuery","remove"],setup(t,a){return w(this,arguments,function*(o,{emit:e}){let n,c;const f=o;let l=null;if(f.query)l=re(f.query),[n,c]=T(()=>l.reload()),yield n,c();else{const m=([n,c]=T(()=>K().create()),n=yield n,c(),n);e("setQuery",m.name),l=re(m.name),[n,c]=T(()=>l.reload()),yield n,c()}[n,c]=T(()=>l.convertToNative()),yield n,c(),P("query",l);const r=Y({dataSource:"",minimizeResult:!0,minimizeQuery:!1,showQueryActions:!1,query:l});return P("state",r),r.removeQuery=()=>{K().delete(l.doc.name).then(()=>e("remove"))},(m,I)=>{var q,u;const C=_("LoadingIndicator");return s(l).doc.name?(d(),g("div",Xt,[i(Zt),i(Fe,{name:"fade",mode:"out-in"},{default:y(()=>[xe(h("div",eo,[i(Ve)],512),[[we,r.query.doc.name&&!r.minimizeQuery]])]),_:1}),((u=(q=r.query.doc)==null?void 0:q.results)==null?void 0:u.length)>1&&!r.minimizeResult?(d(),g("div",to,[i(Ie)])):$("",!0)],512)):(d(),g("div",oo,[i(C,{class:"mb-2 w-6 text-gray-300"})]))}})}},ao={__name:"Query",props:ye,setup(o){const e=o;return(t,a)=>(d(),v(s(be),{class:"not-prose text-base"},{default:y(()=>[(d(),v(ge,null,{default:y(()=>[i(no,{query:e.node.attrs.query,onSetQuery:a[0]||(a[0]=n=>e.updateAttributes({query:n})),onRemove:a[1]||(a[1]=n=>e.deleteNode())},null,8,["query"])]),_:1}))]),_:1}))}},so=Ce({name:"query-editor",tag:"query-editor",component:ao,attributes:{query:void 0}}),ro=Pe.create({name:"slash-commands",addOptions(){return{suggestion:{char:"/",command:({editor:o,range:e,props:t})=>{t.command({editor:o,range:e})}}}},addProseMirrorPlugins(){return[Ee(ae({editor:this.editor},this.options.suggestion))]}}),lo={props:{items:{type:Array,required:!0},editor:{type:Object,required:!0},command:{type:Function,required:!0}},components:{Minus:ut},data(){return{selectedIndex:0}},watch:{items(){this.selectedIndex=0}},computed:{enabledItems(){return this.items.filter(o=>o.disabled?!o.disabled(this.editor):!0)}},methods:{onKeyDown({event:o}){return o.key==="ArrowUp"?(this.upHandler(),!0):o.key==="ArrowDown"?(this.downHandler(),!0):o.key==="Enter"?(this.enterHandler(),!0):!1},upHandler(){this.selectedIndex=(this.selectedIndex+this.enabledItems.length-1)%this.enabledItems.length},downHandler(){this.selectedIndex=(this.selectedIndex+1)%this.enabledItems.length},enterHandler(){this.selectItem(this.selectedIndex)},selectItem(o){const e=this.enabledItems[o];e&&this.command(e)}}},io={class:"flex w-40 flex-col rounded border bg-white p-1 text-base shadow"},co=["onClick","onMouseenter"],uo={key:1,class:"item"};function po(o,e,t,a,n,c){return d(),g("div",io,[c.enabledItems.length?(d(!0),g(O,{key:0},je(c.enabledItems,(f,l)=>(d(),g("button",{class:_e(["flex h-8 w-full cursor-pointer items-center rounded px-1 text-base",{"bg-gray-100":l===n.selectedIndex}]),key:l,onClick:r=>c.selectItem(l),onMouseenter:r=>n.selectedIndex=l},[(d(),v(E(f.icon||"Minus"),{class:"mr-2 h-4 w-4 text-gray-600"})),X(" "+Z(f.title),1)],42,co))),128)):(d(),g("div",uo,"No result"))])}const mo=Ue(lo,[["render",po]]),ho={items:({query:o})=>[{title:"Paragraph",icon:pt,command:({editor:e,range:t})=>{e.chain().focus().deleteRange(t).setNode("paragraph").run()},disabled:e=>e.isActive("table")},{title:"Heading 1",icon:it,command:({editor:e,range:t})=>{e.chain().focus().deleteRange(t).setNode("heading",{level:2}).run()},disabled:e=>e.isActive("table")},{title:"Heading 2",icon:ct,command:({editor:e,range:t})=>{e.chain().focus().deleteRange(t).setNode("heading",{level:3}).run()},disabled:e=>e.isActive("table")},{title:"Heading 3",icon:dt,command:({editor:e,range:t})=>{e.chain().focus().deleteRange(t).setNode("heading",{level:4}).run()},disabled:e=>e.isActive("table")},{title:"Table",icon:ot,command:({editor:e,range:t})=>{e.chain().focus().deleteRange(t).insertTable({rows:3,cols:3,withHeaderRow:!0}).run()},disabled:e=>e.isActive("table")},{title:"Add Column",command:({editor:e,range:t})=>{e.chain().focus().deleteRange(t).addColumnAfter().run()},disabled:e=>!e.isActive("table")},{title:"Add Row",command:({editor:e,range:t})=>{e.chain().focus().deleteRange(t).addRowAfter().run()},disabled:e=>!e.isActive("table")},{title:"Delete Column",command:({editor:e,range:t})=>{e.chain().focus().deleteRange(t).deleteColumn().run()},disabled:e=>!e.isActive("table")},{title:"Delete Row",command:({editor:e,range:t})=>{e.chain().focus().deleteRange(t).deleteRow().run()},disabled:e=>!e.isActive("table")},{title:"Delete Table",command:({editor:e,range:t})=>{e.chain().focus().deleteRange(t).deleteTable().run()},disabled:e=>!e.isActive("table")},{title:"Chart",icon:le(nt),command:({editor:e,range:t})=>{const a="<chart></chart>";e.chain().focus().deleteRange(t).insertContent(a).run()},disabled:e=>!e.isActive("paragraph")||e.isActive("table")},{title:"SQL",icon:le(rt),command:({editor:e,range:t})=>{const a="<query-editor></query-editor>";e.chain().focus().deleteRange(t).insertContent(a).run()},disabled:e=>!e.isActive("paragraph")||e.isActive("table")}].filter(e=>e.title.toLowerCase().includes(o.toLowerCase())),render:()=>{let o,e;return{onStart:t=>{o=new Je(mo,{props:t,editor:t.editor}),t.clientRect&&(e=We("body",{getReferenceClientRect:t.clientRect,appendTo:()=>document.body,content:o.element,showOnCreate:!0,interactive:!0,trigger:"manual",placement:"bottom-start"}))},onUpdate(t){o.updateProps(t),t.clientRect&&e[0].setProps({getReferenceClientRect:t.clientRect})},onKeyDown(t){var a;return t.event.key==="Escape"?(e[0].hide(),!0):(a=o.ref)==null?void 0:a.onKeyDown(t)},onExit(){e[0].destroy(),o.destroy()}}}};const fo={__name:"TipTap",props:["content"],emits:["update:content"],setup(o,{emit:e}){const t=o,a=A(null),n=()=>{const l=a.value.editor.getJSON();e("update:content",l)};Ke(()=>{const l=D(t.content);a.value.editor.commands.setContent(l)}),fe(()=>t.content,l=>{const r=D(l);if(!r)return;const m=a.value.editor.getJSON();JSON.stringify(r)!==JSON.stringify(m)&&a.value.editor.commands.setContent(r)});function c({node:l}){return l.type.name==="heading"?`Heading ${l.attrs.level}`:"Type / to insert a block"}const f=["Bold","Italic",{label:"Strikethrough",icon:ht,action:l=>l.chain().focus().toggleStrike().run(),isActive:l=>l.isActive("strike")},"Blockquote",{label:"Code",icon:lt,action:l=>l.chain().focus().toggleCode().run(),isActive:l=>l.isActive("code")},"Link",{label:"Remove Formatting",icon:mt,action:l=>l.chain().focus().unsetAllMarks().run(),isActive:()=>!1}];return(l,r)=>(d(),v(s(Ge),{ref_key:"tiptap",ref:a,editorClass:"max-w-full prose-h1:font-semibold prose-h1:mt-5 prose-h1:mb-3 prose-h2:font-semibold prose-h2:mt-4 prose-h2:mb-2 prose-p:!my-0 prose-p:py-1 prose-p:text-[16px] prose-p:leading-6 prose-code:before:content-[''] prose-code:after:content-[''] prose-ul:my-0 prose-ol:my-0 prose-li:my-0 prose-th:py-1 prose-td:py-1 prose-blockquote:my-3",onChange:n,"bubble-menu":f,"bubble-menu-options":{shouldShow:m=>m.from===m.to?!1:!m.editor.isActive("query-editor")&&!m.editor.isActive("chart")},placeholder:c,extensions:[s(ro).configure({suggestion:s(ho)}),s(so),s(Pt)]},null,8,["bubble-menu-options","extensions"]))}},yo=fo,go={class:"sticky top-0 z-10 flex items-center justify-between bg-white px-5 py-2.5"},bo={class:"flex flex-1 overflow-hidden bg-white px-6 py-2"},_o={key:0,class:"h-full w-full overflow-y-scroll bg-white pb-96 pt-16 text-base"},vo={class:"w-full px-[6rem] lg:mx-auto lg:max-w-[65rem]"},xo={class:"flex items-center"},wo=h("p",{class:"text-base text-gray-600"},"Are you sure you want to delete this page?",-1),Bo={__name:"NotebookPage",props:{notebook:String,name:String},setup(o){const e=o,t=ft(e.name),a=De(e.notebook);P("page",t);const n=A(!1),c=ve();function f(){t.delete().then(()=>{c.push(`/notebook/${a.doc.name}`)})}const l=V(()=>{var r,m;return{title:(r=t.doc)==null?void 0:r.title,subtitle:(m=t.doc)==null?void 0:m.notebook}});return ze(l),(r,m)=>{const I=_("Dropdown"),C=_("Button"),q=_("Dialog");return d(),g(O,null,[h("header",go,[i(Re,{class:"h-7",items:[{label:"Notebooks",route:{path:"/notebook"}},{label:s(a).doc.title||s(a).doc.name,route:{path:`/notebook/${s(a).doc.name}`}},{label:s(t).doc.title}]},null,8,["items"])]),h("div",bo,[s(t).doc.name?(d(),g("div",_o,[h("div",vo,[h("div",xo,[i(ce,{class:"flex-1 text-[36px] font-bold",modelValue:s(t).doc.title,"onUpdate:modelValue":m[0]||(m[0]=u=>s(t).doc.title=u),placeholder:"Untitled Analysis"},null,8,["modelValue"]),i(I,{button:{icon:"more-horizontal",variant:"ghost"},options:[{label:"Clear",icon:"x-square",onClick:()=>s(t).doc.content={}},{label:"Delete",icon:"trash",onClick:()=>n.value=!0}]},null,8,["options"])]),i(yo,{class:"my-6",content:s(t).doc.content,"onUpdate:content":m[1]||(m[1]=u=>s(t).doc.content=u)},null,8,["content"])])])):$("",!0)]),i(q,{options:{title:"Delete Page",icon:{name:"trash",variant:"solid",theme:"red"}},modelValue:n.value,"onUpdate:modelValue":m[2]||(m[2]=u=>n.value=u),dismissable:!0},{"body-content":y(()=>[wo]),actions:y(()=>[i(C,{variant:"solid",theme:"red",loading:s(t).delete.loading,onClick:f},{default:y(()=>[X(" Yes ")]),_:1},8,["loading"])]),_:1},8,["modelValue"])],64)}}};export{Bo as default};
