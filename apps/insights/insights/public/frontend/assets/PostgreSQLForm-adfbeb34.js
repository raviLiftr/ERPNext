var I=(y,C,_)=>new Promise((e,o)=>{var p=u=>{try{c(_.next(u))}catch(n){o(n)}},r=u=>{try{c(_.throw(u))}catch(n){o(n)}},c=u=>u.done?e(u.value):Promise.resolve(u.value).then(p,r);c((_=_.apply(y,C)).next())});import{f as d,r as x,M as S,v as b,x as B,N as a,O as F,G as U,H as D,L as i,a5 as L,aK as M,a as $,Q as R,w as j,B as T,z as A,aL as Q,F as P}from"./frappe-ui-24524c82.js";import{A as H}from"./index-61e7aa99.js";import{u as O}from"./dataSourceStore-3ba6c3b5.js";import{D as z}from"./vuedraggable.umd-a5e26eb5.js";import{_ as E}from"./Form-5f5c15e9.js";const G={class:"flex flex-col text-base"},K={class:"mb-2 block text-sm leading-4 text-gray-700"},Z=["accept","disabled"],J={__name:"Attachment",props:{modelValue:Object|null,placeholder:String,label:String,fileType:String},emits:["update:modelValue"],setup(y,{emit:C}){const _=y,e=d({get:()=>_.modelValue,set:n=>C("update:modelValue",n)}),o=x(null);function p(){o.value.click()}function r(){o.value.value="",e.value=null}const c=x(!1);function u(n){return I(this,null,function*(){var h;const k=(h=n.target.files)==null?void 0:h[0];if(!k)return;c.value=!0,new M().upload(k,{}).then(g=>{e.value=g}).catch(g=>{e.value=null,console.error(g)}).finally(()=>{c.value=!1})})}return(n,k)=>{var g;const v=S("FeatherIcon"),h=S("Button");return b(),B("div",G,[a("span",K,F(y.label||"Attach File"),1),a("input",{ref_key:"fileInput",ref:o,id:"attachment",type:"file",accept:y.fileType,class:"hidden",disabled:!!e.value,onInput:u},null,40,Z),(g=e.value)!=null&&g.name?(b(),U(h,{key:1,class:"form-input h-7",iconRight:"x",onClick:r},{default:D(()=>[L(F(e.value.file_name),1)]),_:1})):(b(),U(h,{key:0,class:"form-input h-7",onClick:p,loading:c.value},{default:D(()=>[i(v,{name:"upload",class:"mr-1 inline-block h-3 w-3"}),L(" "+F(y.placeholder||"Upload a file"),1)]),_:1},8,["loading"]))])}}},W={class:"mt-4 grid grid-cols-1 gap-4 lg:grid-cols-2"},X=a("span",{class:"mb-2 block text-sm leading-4 text-gray-700"},"Data Source",-1),Y={key:0,class:"mt-4"},ee=a("span",{class:"text-base font-medium leading-6 text-gray-900"}," Columns ",-1),te={key:0,class:"mt-2 flex max-h-[15rem] flex-col overflow-hidden text-base"},le=a("div",{class:"sticky right-0 top-0 z-10 flex h-8 w-full cursor-pointer items-center space-x-8 pr-8 pb-1 text-xs uppercase text-gray-600"},[a("span",{class:"flex-1"}," CSV Column "),a("span",{class:"flex-1"}," Column Name "),a("span",{class:"flex-1"}," Column Type ")],-1),ae={class:"flex flex-col overflow-y-scroll"},ne={class:"flex h-10 w-full cursor-pointer items-center space-x-8 text-gray-600"},se={class:"flex-1 overflow-hidden text-ellipsis whitespace-nowrap text-base font-medium"},oe={key:1,class:"mt-2 flex flex-col items-center justify-center space-y-2 p-12 text-center text-sm"},re=a("p",{class:"text-gray-600"},"Loading columns...",-1),ie={key:2,class:"mt-2 flex flex-col space-y-3 p-12 text-center text-sm text-gray-600"},ue=a("br",null,null,-1),ce={class:"mt-4 flex justify-between pt-2"},de={class:"ml-auto flex items-center space-x-2"},Ce={__name:"FileSourceForm",emits:["submit"],setup(y,{emit:C}){const _=["String","Integer","Decimal","Date","Datetime"],e=$({label:"",name:"",data_source:"Query Store",file:null,ifExists:"Overwrite"}),o=x([]),p=R({url:"insights.api.data_sources.get_columns_from_uploaded_file",initialData:[],onSuccess:l=>{o.value=l==null?void 0:l.map(t=>({label:t.label,name:u(t.label),type:t.type||"String"}))}});function r(l){o.value=o.value.filter(t=>t.column!==l)}const c=d(()=>!e.data_source||!e.label||!e.file||o.length===0||v.value);j(()=>e.file,l=>{var t;e.label=l?(t=l.file_name)==null?void 0:t.replace(/\.[^/.]+$/,""):"",e.name=l?u(e.label):"",l?p.submit({filename:l.name}):p.data=[]});function u(l){return l==null?void 0:l.toLocaleLowerCase().replace(/[^a-zA-Z0-9]/g,"_")}const n=R({url:"insights.api.data_sources.import_csv"}),k=O(),v=x(!1);function h(){v.value=!0;const l={table_label:e.label,table_name:e.name,filename:e.file.name,if_exists:e.ifExists,columns:o.value,data_source:e.data_source};n.submit(l).then(()=>{C("submit"),g()}).catch(t=>{v.value=!1,console.error(t)})}function g(){e.label="",e.name="",e.file=null,e.ifExists="Overwrite",e.data_source="",o.value=[],v.value=!1}return(l,t)=>{var V;S("FeatherIcon");const f=S("Input"),q=S("Button"),m=S("LoadingIndicator");return b(),B(P,null,[a("div",null,[T("",!0),a("div",W,[i(Q,{name:"fade"},{default:D(()=>[a("div",null,[X,i(H,{modelValue:e.data_source,"onUpdate:modelValue":t[1]||(t[1]=s=>e.data_source=s),returnValue:!0,options:A(k).getDropdownOptions({allow_imports:1}),placeholder:"Select Data Source"},null,8,["modelValue","options"])]),i(J,{modelValue:e.file,"onUpdate:modelValue":t[2]||(t[2]=s=>e.file=s),label:"File",fileType:".csv",placeholder:"Upload CSV File"},null,8,["modelValue"]),e.file?(b(),U(f,{key:0,label:"New Table Label",type:"text",placeholder:"eg. Sales Data",modelValue:e.label,"onUpdate:modelValue":t[3]||(t[3]=s=>e.label=s)},null,8,["modelValue"])):T("",!0),e.file?(b(),U(f,{key:1,label:"New Table Name",type:"text",placeholder:"eg. sales_data",modelValue:e.name,"onUpdate:modelValue":t[4]||(t[4]=s=>e.name=s)},null,8,["modelValue"])):T("",!0),e.file?(b(),U(f,{key:2,type:"select",label:"Action if exists",modelValue:e.ifExists,"onUpdate:modelValue":t[5]||(t[5]=s=>e.ifExists=s),options:["Fail","Overwrite","Append"]},null,8,["modelValue"])):T("",!0)]),_:1})])]),e.data_source&&e.file?(b(),B("div",Y,[ee,(V=o.value)!=null&&V.length?(b(),B("div",te,[le,a("div",ae,[i(A(z),{class:"w-full",modelValue:o.value,"onUpdate:modelValue":t[6]||(t[6]=s=>o.value=s),group:"columns","item-key":"column"},{item:D(({element:s})=>[a("div",ne,[a("span",se,F(s.label),1),i(f,{class:"flex-1 !text-sm",type:"text",value:s.name,onChange:w=>s.name=w},null,8,["value","onChange"]),i(f,{class:"flex-1 !text-sm",type:"select",options:_,value:s.type,onChange:w=>s.type=w},null,8,["value","onChange"]),i(q,{class:"!ml-0",icon:"x",variant:"minimal",onClick:w=>r(s.column)},null,8,["onClick"])])]),_:1},8,["modelValue"])])])):A(p).loading?(b(),B("div",oe,[i(m,{class:"h-4 w-4 text-gray-500"}),re])):(b(),B("div",ie,[L(" No columns found in the uploaded file."),ue,L(" Please upload a different file. ")]))])):T("",!0),a("div",ce,[a("div",de,[i(q,{variant:"solid",onClick:h,disabled:c.value,loading:v.value},{default:D(()=>[L(" Import ")]),_:1},8,["disabled","loading"])])])],64)}}},me={class:"mt-6 flex justify-between pt-2"},pe={class:"ml-auto flex items-center space-x-2"},ke={__name:"MariaDBForm",props:{submitLabel:String},emits:["submit"],setup(y,{emit:C}){const _=y,e=$({}),o=x(null),p=[{name:"title",label:"Title",type:"text",placeholder:"My Database",required:!0},{label:"Host",name:"host",type:"text",placeholder:"localhost",required:!0,defaultValue:"localhost"},{label:"Port",name:"port",type:"number",placeholder:"3306",required:!0,defaultValue:3306},{label:"Database Name",name:"name",type:"text",placeholder:"DB_1267891",required:!0},{label:"Username",name:"username",type:"text",placeholder:"read_only_user",required:!0},{label:"Password",name:"password",type:"password",placeholder:"**********",required:!0},{label:"Use secure connection (SSL)?",name:"useSSL",type:"checkbox"}],r=O(),c=d(()=>!!p.filter(m=>m.required).every(m=>e[m.name])),u=d(()=>c.value===!1||r.testing),n=x(null),k=d(()=>r.testing?"":n.value===null?"Connect":n.value?"Connected":"Failed, Retry?"),v=d(()=>{if(n.value!==null)return n.value?"check":"alert-circle"}),h=d(()=>c.value===!1||!n.value||r.creating),g=d(()=>r.creating?"":_.submitLabel||"Add Database"),l=x(!1),t=()=>I(this,null,function*(){e.type="MariaDB",l.value=!0,n.value=yield r.testConnection({database:e}),l.value=!1}),f=x(!1),q=()=>I(this,null,function*(){e.type="MariaDB",f.value=!0,yield r.create({database:e}),f.value=!1,C("submit")});return(m,V)=>{const s=S("Button");return b(),B(P,null,[i(E,{ref_key:"form",ref:o,class:"flex-1",modelValue:e,"onUpdate:modelValue":V[0]||(V[0]=w=>e=w),meta:{fields:p}},null,8,["modelValue","meta"]),a("div",me,[a("div",pe,[i(s,{variant:"outline",disabled:u.value,onClick:t,loadingText:"Connecting...",loading:l.value,iconLeft:v.value},{default:D(()=>[L(F(k.value),1)]),_:1},8,["disabled","loading","iconLeft"]),i(s,{variant:"solid",disabled:h.value,loadingText:"Adding Database...",loading:f.value,onClick:q},{default:D(()=>[L(F(g.value),1)]),_:1},8,["disabled","loading"])])])],64)}}},fe=a("div",{class:"my-4 flex items-center space-x-2 text-sm"},[a("p",{class:"mb-0.5 h-1 flex-1 border-b"}),a("p",null,"OR"),a("p",{class:"mb-0.5 h-1 flex-1 border-b"})],-1),be={class:"mt-6 flex justify-between pt-2"},_e={class:"ml-auto flex items-center space-x-2"},we={__name:"PostgreSQLForm",props:{submitLabel:String},emits:["submit"],setup(y,{emit:C}){const _=y,e=$({}),o=x(null),p=d(()=>[{name:"title",label:"Title",type:"text",placeholder:"My Database",required:!0},{label:"Host",name:"host",type:"text",placeholder:"localhost",required:!e.connection_string,defaultValue:"localhost"},{label:"Port",name:"port",type:"number",placeholder:"3306",required:!e.connection_string,defaultValue:3306},{label:"Database Name",name:"name",type:"text",placeholder:"DB_1267891",required:!e.connection_string},{label:"Username",name:"username",type:"text",placeholder:"read_only_user",required:!e.connection_string},{label:"Password",name:"password",type:"password",placeholder:"**********",required:!e.connection_string},{label:"Use secure connection (SSL)?",name:"useSSL",type:"checkbox"}]),r=O(),c=d(()=>!!(p.value.filter(m=>m.required).every(m=>e[m.name])||e.title&&e.connection_string)),u=d(()=>c.value===!1||r.testing),n=x(null),k=d(()=>r.testing?"":n.value===null?"Connect":n.value?"Connected":"Failed, Retry?"),v=d(()=>{if(n.value!==null)return n.value?"check":"alert-circle"}),h=d(()=>c.value===!1||!n.value||r.creating),g=d(()=>r.creating?"":_.submitLabel||"Add Database"),l=x(!1),t=()=>I(this,null,function*(){e.type="PostgreSQL",l.value=!0,r.testConnection({database:e}).then(m=>{n.value=m}).catch(m=>{n.value=!1}).finally(()=>{l.value=!1})}),f=x(!1),q=()=>I(this,null,function*(){e.type="PostgreSQL",f.value=!0,yield r.create({database:e}),f.value=!1,C("submit")});return(m,V)=>{const s=S("Input"),w=S("Button");return b(),B(P,null,[i(E,{ref_key:"form",ref:o,class:"flex-1",modelValue:e,"onUpdate:modelValue":V[0]||(V[0]=N=>e=N),meta:{fields:p.value}},null,8,["modelValue","meta"]),fe,i(s,{modelValue:e.connection_string,"onUpdate:modelValue":V[1]||(V[1]=N=>e.connection_string=N),label:"Connection String",placeholder:"postgres://user:password@host:port/database"},null,8,["modelValue"]),a("div",be,[a("div",_e,[i(w,{variant:"outline",disabled:u.value,onClick:t,loadingText:"Connecting...",loading:l.value,iconLeft:v.value},{default:D(()=>[L(F(k.value),1)]),_:1},8,["disabled","loading","iconLeft"]),i(w,{variant:"solid",disabled:h.value,loadingText:"Adding Database...",loading:f.value,onClick:q},{default:D(()=>[L(F(g.value),1)]),_:1},8,["disabled","loading"])])])],64)}}};export{ke as _,we as a,Ce as b};
