var f=(a,s,t)=>new Promise((c,u)=>{var i=o=>{try{m(t.next(o))}catch(y){u(y)}},d=o=>{try{m(t.throw(o))}catch(y){u(y)}},m=o=>o.done?c(o.value):Promise.resolve(o.value).then(i,d);m((t=t.apply(a,s)).next())});import{B as I,_ as z,a as V}from"./DashboardEmptyState-9b53962f.js";import{b as H,d as D,w as N}from"./index-61e7aa99.js";import{w as C}from"./widgets-f5903e20.js";import{a as j,aD as Q,aE as T,Q as F,i as W,f as L,w as A,M as G,v as p,x as $,N as _,A as J,z as h,L as x,B as E,G as w,H as g,Z as K,D as M,O as Z}from"./frappe-ui-24524c82.js";import U from"./InvalidWidget-3dda2fff.js";import{u as X}from"./useChartData-c190b291.js";import"./results-60b5fd7f.js";function Y(a){const s=tt(a),t=j({isPublic:!0,doc:{doctype:"Insights Dashboard",name:void 0,owner:void 0,title:void 0,items:[]},loading:!1,itemLayouts:[],filterStates:{},filtersByChart:{},refreshCallbacks:[]});function c(){return f(this,null,function*(){t.loading=!0,yield s.fetch(),t.doc=s.data,t.itemLayouts=t.doc.items.map(q),t.loading=!1})}c();function u(e){return`filterState-${t.doc.name}-${e}`}function i(e){return f(this,null,function*(){return t.filterStates[e]||(t.filterStates[e]=yield Q(u(e))),t.filterStates[e]})}function d(e,r){return f(this,null,function*(){const n=r?{operator:r.operator,value:r.value}:void 0;H(n,t.filterStates[e])||T(u(e),n).then(()=>{t.filterStates[e]=n,m(e)})})}function m(e){t.doc.items.some(r=>{if(r.item_id===e)return(Object.keys(r.options.links)||[]).forEach(l=>{o(l)}),!0})}function o(e){return f(this,null,function*(){const r=t.doc.items.filter(l=>l.item_type==="Filter").map(l=>f(this,null,function*(){var S,B;const v=(S=l.options.links)==null?void 0:S[e];if(!v)return;const b=yield i(l.item_id);if(!(!b||!((B=b.value)!=null&&B.value)))return{label:l.options.label,column:v,value:b.value.value,operator:b.operator.value,column_type:v.type}})),n=yield Promise.all(r);t.filtersByChart[e]=n.filter(Boolean)})}function y(e){return f(this,null,function*(){return t.filtersByChart[e]||(yield o(e)),t.filtersByChart[e]})}function k(e,r){return f(this,null,function*(){if(r||t.doc.items.some(l=>{if(l.item_id===e)return r=l.options.query,!0}),!r)throw new Error(`Query not found for item ${e}`);const n=yield y(e);return yield s.fetch_chart_data.submit({public_key:a,item_id:e,query_name:r,filters:n})})}function O(e){const r=t.doc.items.find(n=>n.item_id===e);Object.keys(r.options.links).forEach(n=>{Object.keys(t.queryResults).forEach(l=>{l.startsWith(`${n}-`)&&(delete t.queryResults[l],k(n))})})}function P(){return f(this,null,function*(){yield c(),t.refreshCallbacks.forEach(e=>e())})}function R(e){t.refreshCallbacks.push(e)}function q(e){return{i:parseInt(e.item_id),x:e.layout.x||0,y:e.layout.y||0,w:e.layout.w||C[e.item_type].defaultWidth,h:e.layout.h||C[e.item_type].defaultHeight}}return Object.assign(t,{reload:c,getChartResults:k,getFilterStateKey:u,getFilterState:i,setFilterState:d,refreshFilter:O,refreshChartFilters:o,refresh:P,onRefresh:R,isChart:e=>!["Filter","Text"].includes(e.item_type)})}function tt(a){const s=F({url:"insights.api.public.get_public_dashboard",params:{public_key:a},transform(t){return t.items=t.items.map(et),t}});return s.fetch_chart_data=F({url:"insights.api.public.get_public_dashboard_chart_data"}),s}function et(a){return a.options=D(a.options,{}),a.layout=D(a.layout,{}),a}const at={class:"dashboard-item h-full min-h-[60px] w-full p-1.5"},st={class:"flex h-full w-full"},rt={key:0,class:"absolute inset-0 z-[10000] flex h-full w-full items-center justify-center rounded bg-white"},it={__name:"PublicDashboardItem",props:{item:{type:Object,required:!0}},setup(a){const s=a,t=W("dashboard");let c=null,u=t.isChart(s.item),i=j({});if(u){const d=L(()=>s.item.options.query);i=X({resultsFetcher(){return t.getChartResults(s.item.item_id)}}),N(d,()=>i.load(d.value),{immediate:!0}),t.onRefresh(()=>i.load(d.value)),c=L(()=>t.filtersByChart[s.item.item_id]),t.refreshChartFilters(s.item.item_id),A(c,()=>{i.load(s.item.options.query)})}return(d,m)=>{const o=G("LoadingIndicator");return p(),$("div",at,[_("div",st,[_("div",{class:J(["group relative flex h-full w-full rounded",{"bg-white shadow":a.item.item_type!=="Filter"&&a.item.item_type!=="Text"}])},[h(i).loading?(p(),$("div",rt,[x(o,{class:"w-6 text-gray-300"})])):E("",!0),(p(),w(K(h(C).getComponent(a.item.item_type)),{ref:"widget",data:h(i).data,item_id:a.item.item_id,options:a.item.options},{placeholder:g(()=>[x(U,{class:"absolute",title:"Insufficient options",icon:"settings",message:null,"icon-class":"text-gray-500"})]),_:1},8,["data","item_id","options"]))],2)])])}}},ot={class:"whitespace-nowrap px-1.5 text-2xl font-medium"},nt={class:"h-full w-full overflow-y-scroll bg-white px-4 py-2"},lt={ref:"gridLayout",class:"relative flex h-fit min-h-screen w-full flex-1 flex-col"},bt={__name:"PublicDashboard",props:{public_key:String},setup(a){const t=Y(a.public_key);return M("dashboard",t),(c,u)=>(p(),w(I,null,{navbar:g(()=>[_("div",ot,Z(h(t).doc.title),1)]),content:g(()=>[_("div",nt,[_("div",lt,[x(z,{class:"h-fit w-full",items:h(t).doc.items,disabled:!0,layouts:h(t).itemLayouts},{item:g(({item:i})=>[(p(),w(it,{item:i,key:i.item_id},null,8,["item"]))]),_:1},8,["items","layouts"]),h(t).doc.items.length?E("",!0):(p(),w(V,{key:0,class:"absolute left-1/2 top-1/2 mx-auto -translate-x-1/2 -translate-y-1/2 transform"}))],512)])]),_:1}))}};export{bt as default};
